<!DOCTYPE html>
<html>
<head>
  <title>Stock Analysis Dashboard</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <style>
    :root{--card:#fff;--accent:#007bff;--txt:#333;--muted:#666}
    body{font-family:Arial,Helvetica,sans-serif;background:#f4f4f4;margin:0;padding:20px;color:var(--txt)}
    .container{max-width:1200px;margin:0 auto}
    .header{background:#222;color:#fff;padding:20px;border-radius:8px;text-align:center}
    .back{display:inline-block;margin:10px 0 20px;padding:8px 16px;background:var(--accent);color:#fff;text-decoration:none;border-radius:4px}
    .metric-card{background:var(--card);padding:20px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.1);margin-bottom:20px}
    .metric-card h3{margin:0 0 15px;border-bottom:2px solid var(--accent);padding-bottom:10px}
    .price-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px}
    .price-stat{background:#e9ecef;padding:15px;border-radius:5px;text-align:center}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin:20px 0}
    .row{display:flex;justify-content:space-between;margin:10px 0;padding:8px 0;border-bottom:1px solid #eee}
    .label{font-weight:700;color:var(--muted)}
    .val{color:var(--txt)}
    .positive{color:#28a745;font-weight:700}
    .negative{color:#dc3545;font-weight:700}
    .loading{text-align:center;color:var(--muted);padding:40px}
    .error{text-align:center;color:#dc3545;padding:20px}
  </style>
</head>
<body>
<div class="container">
  <a href="index.html" class="back">‚Üê Back to Email Report</a>

  <div class="header">
    <h1 id="sym">Loading‚Ä¶</h1>
    <p id="source" style="font-size:12px;opacity:.8;">Data source: TwelveData ‚Üí Netlify (Live, 30 min cache)</p>
  </div>

  <div id="loading" class="loading">Fetching live data‚Ä¶</div>
  <div id="error"   class="error" style="display:none;"></div>

  <div id="content" style="display:none;">
    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Market card ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="metric-card">
      <h3>Current Market Data</h3>
      <div class="price-stats">
        <div class="price-stat">Price <strong id="price">-</strong></div>
        <div class="price-stat">Change <strong id="change">-</strong></div>
        <div class="price-stat">Change % <strong id="chgPct">-</strong></div>
        <div class="price-stat">Open <strong id="open">-</strong></div>
        <div class="price-stat">High <strong id="high">-</strong></div>
        <div class="price-stat">Low <strong id="low">-</strong></div>
        <div class="price-stat">Volume <strong id="vol">-</strong></div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Metric grid ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="grid">
      <!-- Dividend -->
      <div class="metric-card"><h3>üí∞ Dividend</h3>
        <div class="row"><span class="label">Yield</span><span class="val" id="divY">-</span></div>
        <div class="row"><span class="label">Annual</span><span class="val" id="divAmt">-</span></div>
        <div class="row"><span class="label">Ex-Date</span><span class="val" id="exDiv">-</span></div>
        <div class="row"><span class="label">CAGR 3 Y</span><span class="val" id="divC3">-</span></div>
        <div class="row"><span class="label">CAGR 5 Y</span><span class="val" id="divC5">-</span></div>
      </div>

      <!-- Price CAGR -->
      <div class="metric-card"><h3>üìà Price CAGR</h3>
        <div class="row"><span class="label">1 Y</span><span class="val" id="p1y">-</span></div>
        <div class="row"><span class="label">3 Y</span><span class="val" id="p3y">-</span></div>
        <div class="row"><span class="label">5 Y</span><span class="val" id="p5y">-</span></div>
        <div class="row"><span class="label">10 Y</span><span class="val" id="p10y">-</span></div>
        <div class="row"><span class="label">15 Y</span><span class="val" id="p15y">-</span></div>
      </div>

      <!-- EPS -->
      <div class="metric-card"><h3>üí° EPS Growth</h3>
        <div class="row"><span class="label">Current</span><span class="val" id="epsNow">-</span></div>
        <div class="row"><span class="label">Growth 1 Y</span><span class="val" id="epsG1">-</span></div>
        <div class="row"><span class="label">CAGR 3 Y</span><span class="val" id="epsC3">-</span></div>
        <div class="row"><span class="label">CAGR 5 Y</span><span class="val" id="epsC5">-</span></div>
      </div>

      <!-- FCF -->
      <div class="metric-card"><h3>üíµ Free Cash Flow</h3>
        <div class="row"><span class="label">Current</span><span class="val" id="fcfNow">-</span></div>
        <div class="row"><span class="label">Growth 1 Y</span><span class="val" id="fcfG1">-</span></div>
        <div class="row"><span class="label">CAGR 3 Y</span><span class="val" id="fcfC3">-</span></div>
        <div class="row"><span class="label">CAGR 5 Y</span><span class="val" id="fcfC5">-</span></div>
        <div class="row"><span class="label">CAGR 10 Y</span><span class="val" id="fcfC10">-</span></div>
      </div>

      <!-- Revenue -->
      <div class="metric-card"><h3>üìä Revenue Growth</h3>
        <div class="row"><span class="label">Current</span><span class="val" id="revNow">-</span></div>
        <div class="row"><span class="label">Growth 1 Y</span><span class="val" id="revG1">-</span></div>
        <div class="row"><span class="label">CAGR 3 Y</span><span class="val" id="revC3">-</span></div>
        <div class="row"><span class="label">CAGR 5 Y</span><span class="val" id="revC5">-</span></div>
        <div class="row"><span class="label">CAGR 10 Y</span><span class="val" id="revC10">-</span></div>
        <div class="row"><span class="label">CAGR 15 Y</span><span class="val" id="revC15">-</span></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ helper functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const cagr=(s,e,y)=>(!s||!e||y<=0)?null:Math.pow(e/s,1/y)-1;
const cur=(v,c='$')=>{
  if(!v||isNaN(v)) return '-';
  const a=Math.abs(v); let n=v,u='';
  if(a>=1e12){n=v/1e12;u='T'}
  else if(a>=1e9){n=v/1e9;u='B'}
  else if(a>=1e6){n=v/1e6;u='M'}
  else if(a>=1e3){n=v/1e3;u='K'}
  return c+n.toFixed(2)+u;
};
const pct=v=>(!v||isNaN(v))?'-':(v>=0?'+':'')+(v*100).toFixed(2)+'%';
function put(id,v,isPct=false,isCur=false,curSym='$'){
  const el=document.getElementById(id); if(!el) return;
  if(isCur)       el.textContent=cur(v,curSym);
  else if(isPct) {el.textContent=pct(v); el.className=v>=0?'positive':'negative';}
  else            el.textContent=v??'-';
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Netlify on-demand loader (30 min cache) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function loadJSON(symbol, endpoint){
  const url = `/api/stock?symbol=${encodeURIComponent(symbol)}&endpoint=${endpoint}`;
  const r=await fetch(url);
  if(!r.ok) throw new Error(`${endpoint} fetch failed`);
  return await r.json();
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ main render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function render(sym){
  try{
    document.getElementById('loading').textContent=`Loading ${sym}‚Ä¶`;
    const curSym = sym.match(/\\.NS|\\.BO$/) ? '‚Çπ' : '$';

    /* quote */
    const q = await loadJSON(sym,'quote');
    put('price', +q.close,false,true,curSym);
    put('change',+q.change,false,true,curSym);
    put('chgPct',+q.percent_change/100,true);
    ['open','high','low'].forEach(f=>put(f,+q[f],false,true,curSym));
    put('vol',(+q.volume).toLocaleString());

    /* price series */
    const ts = await loadJSON(sym,'time_series');
    if(ts.values){
      const p=ts.values.reverse();
      const now=+p.at(-1).close;
      [1,3,5,10,15].forEach(y=>{
        const i=p.length-1-y*252;
        if(i>=0) put(`p${y}y`,cagr(+p[i].close,now,y),true);
      });
    }

    /* dividends */
    try{
      const d=await loadJSON(sym,'dividends');
      if(d.length){
        const latest=d[0];
        const annual=d.slice(0,4).reduce((s,x)=>s+ +x.amount,0);
        put('divAmt',annual,false,true,curSym);
        put('divY',(annual/q.close)*100,true);
        put('exDiv',latest.ex_date);
        if(d.length>=36) put('divC3',cagr(+d[35].amount,+latest.amount,3),true);
        if(d.length>=60) put('divC5',cagr(+d[59].amount,+latest.amount,5),true);
      }
    }catch{}

    /* earnings */
    try{
      const e=await loadJSON(sym,'earnings');
      if(e.length){
        const cur=+e[0].eps_actual;
        put('epsNow',cur,false,true,curSym);
        if(e.length>=4) put('epsG1',cagr(+e[3].eps_actual,cur,1),true);
        [3,5].forEach(y=>{
          const q=y*4;
          if(e.length>=q) put(`epsC${y}`,cagr(+e[q-1].eps_actual,cur,y),true);
        });
      }
    }catch{}

    /* cash-flow & income */
    try{
      const cf =await loadJSON(sym,'cash_flow');
      const inc=await loadJSON(sym,'income_statement');

      if(cf.length){
        const fcf=+(cf[0].free_cash_flow||cf[0].operating_cash_flow||0);
        put('fcfNow',fcf,false,true,curSym);
        [1,3,5,10].forEach(y=>{
          if(cf.length>y)
            put(`fcf${y===1?'G1':`C${y}`}`,cagr(+(cf[y].free_cash_flow||cf[y].operating_cash_flow||0),fcf,y),true);
        });
      }

      if(inc.length){
        const rev=+inc[0].total_revenue;
        put('revNow',rev,false,true,curSym);
        [1,3,5,10,15].forEach(y=>{
          if(inc.length>y)
            put(`rev${y===1?'G1':`C${y}`}`,cagr(+inc[y].total_revenue,rev,y),true);
        });
      }
    }catch{}

    document.getElementById('loading').style.display='none';
    document.getElementById('content').style.display='block';
  }catch(err){
    document.getElementById('loading').style.display='none';
    const er=document.getElementById('error');
    er.style.display='block';
    er.textContent='Error: '+err.message;
    console.error(err);
  }
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ entry ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
window.onload=()=>{
  const params=new URLSearchParams(location.search);
  const sym   =params.get('symbol')||'AAPL';
  document.getElementById('sym').textContent=sym;
  document.title=`${sym} ‚Äì Dashboard`;
  render(sym);
};
</script>
</body>
</html>
