<!DOCTYPE html>
<html>
<head>
  <title>Stock Dashboard - Multi-Market</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    .header { background: #222; color: white; padding: 20px; border-radius: 8px; text-align: center; }
    .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
    .metric-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .metric-card h3 { margin: 0 0 15px 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
    .metric-row { display: flex; justify-content: space-between; margin: 10px 0; padding: 8px 0; border-bottom: 1px solid #eee; }
    .metric-label { font-weight: bold; color: #666; }
    .metric-value { color: #333; }
    .positive { color: #28a745; font-weight: bold; }
    .negative { color: #dc3545; font-weight: bold; }
    .loading { text-align: center; color: #666; padding: 40px; }
    .error { text-align: center; color: #dc3545; padding: 20px; }
    .price-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
    .price-stat { background: #e9ecef; padding: 15px; border-radius: 5px; text-align: center; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 id="stock-symbol">Loading...</h1>
      <p id="company-name">&nbsp;</p>
      <p id="source" style="font-size: 12px; opacity: 0.8;"></p>
    </div>
    
    <div id="loading" class="loading">Fetching comprehensive stock data...</div>
    <div id="error" class="error" style="display:none;"></div>
    
    <div id="content" style="display:none;">
      <!-- Current Price Stats -->
      <div class="metric-card">
        <h3>Current Market Data</h3>
        <div class="price-stats">
          <div class="price-stat">Price: <strong id="price">-</strong></div>
          <div class="price-stat">Change: <strong id="change">-</strong></div>
          <div class="price-stat">Change %: <strong id="change-percent">-</strong></div>
          <div class="price-stat">Open: <strong id="open">-</strong></div>
          <div class="price-stat">High: <strong id="high">-</strong></div>
          <div class="price-stat">Low: <strong id="low">-</strong></div>
          <div class="price-stat">Volume: <strong id="volume">-</strong></div>
        </div>
      </div>

      <div class="metrics-grid">
        <!-- Dividend Information -->
        <div class="metric-card">
          <h3>ðŸ’° Dividend Information</h3>
          <div class="metric-row">
            <span class="metric-label">Current Dividend Yield:</span>
            <span class="metric-value" id="dividend-yield">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Annual Dividend Amount:</span>
            <span class="metric-value" id="dividend-amount">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Ex-Dividend Date:</span>
            <span class="metric-value" id="ex-dividend-date">-</span>
          </div>
        </div>

        <!-- Stock Price CAGR -->
        <div class="metric-card">
          <h3>ðŸ“ˆ Stock Price CAGR</h3>
          <div class="metric-row">
            <span class="metric-label">1 Year CAGR:</span>
            <span class="metric-value" id="price-cagr-1y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">3 Year CAGR:</span>
            <span class="metric-value" id="price-cagr-3y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">5 Year CAGR:</span>
            <span class="metric-value" id="price-cagr-5y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">10 Year CAGR:</span>
            <span class="metric-value" id="price-cagr-10y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">15 Year CAGR:</span>
            <span class="metric-value" id="price-cagr-15y">-</span>
          </div>
        </div>

        <!-- EPS Growth -->
        <div class="metric-card">
          <h3>ðŸ’¡ EPS Growth Rates</h3>
          <div class="metric-row">
            <span class="metric-label">Current EPS:</span>
            <span class="metric-value" id="current-eps">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">1 Year EPS Growth:</span>
            <span class="metric-value" id="eps-growth-1y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">3 Year EPS CAGR:</span>
            <span class="metric-value" id="eps-cagr-3y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">5 Year EPS CAGR:</span>
            <span class="metric-value" id="eps-cagr-5y">-</span>
          </div>
        </div>

        <!-- Free Cash Flow -->
        <div class="metric-card">
          <h3>ðŸ’µ Free Cash Flow</h3>
          <div class="metric-row">
            <span class="metric-label">Current FCF:</span>
            <span class="metric-value" id="current-fcf">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">1 Year FCF Growth:</span>
            <span class="metric-value" id="fcf-growth-1y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">3 Year FCF CAGR:</span>
            <span class="metric-value" id="fcf-cagr-3y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">5 Year FCF CAGR:</span>
            <span class="metric-value" id="fcf-cagr-5y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">10 Year FCF CAGR:</span>
            <span class="metric-value" id="fcf-cagr-10y">-</span>
          </div>
        </div>

        <!-- Revenue -->
        <div class="metric-card">
          <h3>ðŸ“Š Revenue Growth</h3>
          <div class="metric-row">
            <span class="metric-label">Current Revenue:</span>
            <span class="metric-value" id="current-revenue">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">1 Year Revenue Growth:</span>
            <span class="metric-value" id="revenue-growth-1y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">3 Year Revenue CAGR:</span>
            <span class="metric-value" id="revenue-cagr-3y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">5 Year Revenue CAGR:</span>
            <span class="metric-value" id="revenue-cagr-5y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">10 Year Revenue CAGR:</span>
            <span class="metric-value" id="revenue-cagr-10y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">15 Year Revenue CAGR:</span>
            <span class="metric-value" id="revenue-cagr-15y">-</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const TD_API_KEY = 'demo'; // Replace with your TwelveData API key

    function isIndianStock(symbol) {
      return symbol.includes('.NS') || symbol.includes('.BO');
    }

    // TwelveData API calls
    async function tdCall(endpoint, params = {}) {
      const paramString = new URLSearchParams({...params, apikey: TD_API_KEY}).toString();
      const url = `https://api.twelvedata.com/${endpoint}?${paramString}`;
      
      const response = await fetch(url);
      const data = await response.json();
      
      if (data.status === 'error') {
        throw new Error(data.message || 'TwelveData API error');
      }
      
      return data;
    }

    // Yahoo Finance API calls (for Indian stocks)
    async function yahooCall(symbol) {
      const proxyUrl = 'https://api.allorigins.win/raw?url=';
      const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}`;
      
      const response = await fetch(proxyUrl + encodeURIComponent(yahooUrl));
      const data = await response.json();
      
      if (!data?.chart?.result?.[0]) {
        throw new Error('No data from Yahoo Finance');
      }
      
      return data.chart.result[0];
    }

    async function getYahooQuote(symbol) {
      const data = await yahooCall(symbol);
      const meta = data.meta;
      
      return {
        close: meta.regularMarketPrice || meta.previousClose,
        change: meta.regularMarketPrice - meta.previousClose,
        percent_change: ((meta.regularMarketPrice - meta.previousClose) / meta.previousClose) * 100,
        open: meta.regularMarketOpen,
        high: meta.regularMarketDayHigh,
        low: meta.regularMarketDayLow,
        volume: meta.regularMarketVolume || 0
      };
    }

    async function getYahooHistoricalData(symbol, years = 15) {
      const endDate = Math.floor(Date.now() / 1000);
      const startDate = endDate - (years * 365 * 24 * 60 * 60);
      
      const proxyUrl = 'https://api.allorigins.win/raw?url=';
      const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?period1=${startDate}&period2=${endDate}&interval=1d`;
      
      const response = await fetch(proxyUrl + encodeURIComponent(yahooUrl));
      const data = await response.json();
      
      if (!data?.chart?.result?.[0]?.timestamp) {
        throw new Error('No historical data from Yahoo Finance');
      }
      
      const result = data.chart.result[0];
      const timestamps = result.timestamp;
      const prices = result.indicators.adjclose[0].adjclose;
      
      return timestamps.map((timestamp, index) => ({
        date: new Date(timestamp * 1000).toISOString().split('T')[0],
        close: prices[index]
      })).filter(item => item.close !== null);
    }

    function calculateCAGR(startValue, endValue, years) {
      if (!startValue || !endValue || years <= 0) return null;
      return Math.pow(endValue / startValue, 1 / years) - 1;
    }

    function formatCurrency(value, currency = '$') {
      if (!value || isNaN(value)) return '-';
      const absValue = Math.abs(value);
      let formatted;
      
      if (absValue >= 1e12) formatted = (value / 1e12).toFixed(2) + 'T';
      else if (absValue >= 1e9) formatted = (value / 1e9).toFixed(2) + 'B';
      else if (absValue >= 1e6) formatted = (value / 1e6).toFixed(2) + 'M';
      else if (absValue >= 1e3) formatted = (value / 1e3).toFixed(2) + 'K';
      else formatted = value.toFixed(2);
      
      return currency + formatted;
    }

    function formatPercentage(value) {
      if (!value || isNaN(value)) return '-';
      const formatted = (value * 100).toFixed(2) + '%';
      return value >= 0 ? '+' + formatted : formatted;
    }

    function updateElement(id, value, isPercentage = false, isCurrency = false, currency = '$') {
      const element = document.getElementById(id);
      if (!element) return;
      
      if (isCurrency) {
        element.textContent = formatCurrency(value, currency);
      } else if (isPercentage) {
        element.textContent = formatPercentage(value);
        element.className = value >= 0 ? 'positive' : 'negative';
      } else {
        element.textContent = value || '-';
      }
    }

    async function loadStockData(symbol) {
      try {
        console.log('Loading comprehensive data for:', symbol);
        
        const isIndian = isIndianStock(symbol);
        const currency = isIndian ? 'â‚¹' : '$';
        let dataSource = '';

        // 1. Get Current Quote
        let quote;
        if (isIndian) {
          console.log('Fetching Indian stock data from Yahoo Finance...');
          quote = await getYahooQuote(symbol);
          dataSource = 'Yahoo Finance (Indian Stock)';
        } else {
          console.log('Fetching US stock data from TwelveData...');
          quote = await tdCall('quote', { symbol });
          dataSource = 'TwelveData';
        }
        
        // Update current price display
        document.getElementById('price').textContent = formatCurrency(parseFloat(quote.close), currency);
        updateElement('change', parseFloat(quote.change), false, true, currency);
        updateElement('change-percent', parseFloat(quote.percent_change) / 100, true);
        updateElement('open', parseFloat(quote.open), false, true, currency);
        updateElement('high', parseFloat(quote.high), false, true, currency);
        updateElement('low', parseFloat(quote.low), false, true, currency);
        updateElement('volume', parseInt(quote.volume)?.toLocaleString());

        // 2. Get Historical Price Data for CAGR
        let historicalData;
        if (isIndian) {
          console.log('Fetching Indian historical price data...');
          historicalData = await getYahooHistoricalData(symbol);
        } else {
          console.log('Fetching US historical price data...');
          const tdHistorical = await tdCall('time_series', { 
            symbol, 
            interval: '1day', 
            outputsize: 5000 
          });
          historicalData = tdHistorical.values ? tdHistorical.values.reverse() : [];
        }
        
        if (historicalData.length > 0) {
          const currentPrice = parseFloat(historicalData[historicalData.length - 1].close);
          
          console.log(`Processing ${historicalData.length} historical price points`);
          
          // Calculate Price CAGR
          [1, 3, 5, 10, 15].forEach(years => {
            const daysBack = years * 252; // trading days
            if (historicalData.length > daysBack) {
              const historicalPrice = parseFloat(historicalData[historicalData.length - 1 - daysBack].close);
              const cagr = calculateCAGR(historicalPrice, currentPrice, years);
              updateElement(`price-cagr-${years}y`, cagr, true);
              console.log(`${years}Y Price CAGR: ${(cagr * 100).toFixed(2)}%`);
            }
          });
        }

        // 3. Fundamental Data (US stocks only via TwelveData)
        if (!isIndian) {
          console.log('Fetching fundamental data for US stock...');
          
          // Dividends
          try {
            const dividends = await tdCall('dividends', { symbol });
            if (dividends && Array.isArray(dividends) && dividends.length > 0) {
              const latestDiv = dividends[0];
              const annualDividend = dividends.slice(0, 4).reduce((sum, div) => sum + parseFloat(div.amount || 0), 0);
              const dividendYield = (annualDividend / parseFloat(quote.close)) * 100;
              
              updateElement('dividend-yield', dividendYield + '%');
              updateElement('dividend-amount', annualDividend, false, true, currency);
              updateElement('ex-dividend-date', latestDiv.ex_date || 'N/A');
            }
          } catch (error) {
            console.log('Dividend data not available:', error.message);
          }

          // Earnings
          try {
            const earnings = await tdCall('earnings', { symbol });
            if (earnings && Array.isArray(earnings) && earnings.length > 0) {
              const latestEarnings = earnings[0];
              updateElement('current-eps', latestEarnings.eps_actual, false, true, currency);
              
              if (earnings.length >= 4) {
                const eps1YearAgo = parseFloat(earnings[3]?.eps_actual || 0);
                const currentEPS = parseFloat(latestEarnings.eps_actual || 0);
                const epsGrowth1Y = calculateCAGR(eps1YearAgo, currentEPS, 1);
                updateElement('eps-growth-1y', epsGrowth1Y, true);
              }
            }
          } catch (error) {
            console.log('Earnings data not available:', error.message);
          }

          // Cash Flow
          try {
            const cashFlow = await tdCall('cash_flow', { symbol });
            if (cashFlow && Array.isArray(cashFlow) && cashFlow.length > 0) {
              const latestCF = cashFlow[0];
              const fcf = parseFloat(latestCF.free_cash_flow || latestCF.operating_cash_flow || 0);
              updateElement('current-fcf', fcf, false, true, currency);
            }
          } catch (error) {
            console.log('Cash flow data not available:', error.message);
          }

          // Revenue
          try {
            const incomeStatement = await tdCall('income_statement', { symbol });
            if (incomeStatement && Array.isArray(incomeStatement) && incomeStatement.length > 0) {
              const latestIncome = incomeStatement[0];
              const revenue = parseFloat(latestIncome.total_revenue || 0);
              updateElement('current-revenue', revenue, false, true, currency);
            }
          } catch (error) {
            console.log('Revenue data not available:', error.message);
          }
        } else {
          console.log('Skipping fundamental data for Indian stock (not available)');
          dataSource += ' (Price data only - Fundamental data limited for Indian stocks)';
        }

        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';
        document.getElementById('source').textContent = `Data source: ${dataSource}`;
        
        console.log('Data loading completed successfully');
        
      } catch (error) {
        console.error('Error loading stock data:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
        document.getElementById('error').textContent = `Error loading data: ${error.message}`;
      }
    }

    async function main() {
      const urlParams = new URLSearchParams(window.location.search);
      const symbol = urlParams.get('symbol') || 'AAPL';
      
      document.getElementById('stock-symbol').textContent = symbol;
      document.title = `${symbol} - Multi-Market Stock Analysis`;
      
      await loadStockData(symbol);
    }

    window.onload = main;
  </script>
</body>
</html>
