<!DOCTYPE html>
<html>
<head>
  <title>Stock Dashboard â€“ Secure</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body {font-family:Arial, sans-serif; background:#f4f4f4; margin:0; padding:20px;}
    .container {max-width:1200px; margin:0 auto;}
    .header   {background:#222; color:#fff; padding:20px; border-radius:8px; text-align:center;}
    .metrics-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:20px; margin:20px 0;}
    .metric-card{background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,.1);}
    .metric-card h3{margin:0 0 15px; border-bottom:2px solid #007bff; padding-bottom:10px; color:#333;}
    .metric-row{display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #eee;}
    .metric-label{font-weight:700; color:#666;}
    .metric-value{color:#333;}
    .positive{color:#28a745; font-weight:700;}
    .negative{color:#dc3545; font-weight:700;}
    .loading{text-align:center; color:#666; padding:40px;}
    .error{text-align:center; color:#dc3545; padding:20px;}
    .price-stats{display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:15px;}
    .price-stat{background:#e9ecef; padding:15px; border-radius:5px; text-align:center;}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 id="stock-symbol">Loadingâ€¦</h1>
      <p id="source" style="font-size:12px; opacity:.8;"></p>
    </div>

    <div id="loading" class="loading">Fetching dataâ€¦</div>
    <div id="error"   class="error"   style="display:none;"></div>

    <div id="content" style="display:none;">
      <div class="metric-card">
        <h3>Current Market Data</h3>
        <div class="price-stats">
          <div class="price-stat">Price: <strong id="price">-</strong></div>
          <div class="price-stat">Change: <strong id="change">-</strong></div>
          <div class="price-stat">Change %: <strong id="change-percent">-</strong></div>
          <div class="price-stat">Open: <strong id="open">-</strong></div>
          <div class="price-stat">High: <strong id="high">-</strong></div>
          <div class="price-stat">Low: <strong id="low">-</strong></div>
          <div class="price-stat">Volume: <strong id="volume">-</strong></div>
        </div>
      </div>

      <div class="metrics-grid">
        <!-- ONE template card shown â€“ keep the others you already have -->
        <div class="metric-card">
          <h3>ðŸ“ˆ Stock Price CAGR</h3>
          <div class="metric-row"><span class="metric-label">1 Year:</span><span class="metric-value" id="price-cagr-1y">-</span></div>
          <div class="metric-row"><span class="metric-label">3 Years:</span><span class="metric-value" id="price-cagr-3y">-</span></div>
          <div class="metric-row"><span class="metric-label">5 Years:</span><span class="metric-value" id="price-cagr-5y">-</span></div>
          <div class="metric-row"><span class="metric-label">10 Years:</span><span class="metric-value" id="price-cagr-10y">-</span></div>
          <div class="metric-row"><span class="metric-label">15 Years:</span><span class="metric-value" id="price-cagr-15y">-</span></div>
        </div>
        <!-- keep your other cards unchanged -->
      </div>
    </div>
  </div>

<script>
/* ---------- helpers ---------- */
const isIndian = s => s.includes('.NS') || s.includes('.BO');
const formatCurrency = (v, c='$') => isNaN(v)?'-':c+Number(v).toLocaleString(undefined,{maximumFractionDigits:2});
const formatPct      = v => isNaN(v)?'-':(v>=0?'+':'')+(v*100).toFixed(2)+'%';
function update(id,val,opt={}){const el=document.getElementById(id);if(!el)return;
  if(opt.pct)  {el.textContent=formatPct(val);el.className=val>=0?'positive':'negative';}
  else if(opt.cur){el.textContent=formatCurrency(val,opt.cur);}
  else el.textContent=val??'-';
}

/* ---------- data loaders ---------- */
async function fetchLocalJSON(path){
  const res=await fetch(path,{cache:'no-store'});
  if(!res.ok) throw new Error('missing '+path);
  return res.json();
}

async function getQuote(symbol){
  return fetchLocalJSON(`./data/${symbol}.json`);
}
async function getHist(symbol){
  return fetchLocalJSON(`./data/${symbol}_historical.json`);
}
/* Indian fallback */
async function getQuoteYahoo(symbol){
  const url='https://api.allorigins.win/raw?url='+encodeURIComponent(
    `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}`);
  const data=await fetch(url).then(r=>r.json());
  const m=data.chart.result[0].meta;
  return{
    close:m.regularMarketPrice||m.previousClose,
    change:m.regularMarketPrice-m.previousClose,
    percent_change:(m.regularMarketPrice-m.previousClose)/m.previousClose*100,
    open:m.regularMarketOpen,high:m.regularMarketDayHigh,
    low:m.regularMarketDayLow,volume:m.regularMarketVolume};
}
async function getHistYahoo(symbol,years=15){
  const now=Math.floor(Date.now()/1000),start=now-years*365*24*60*60;
  const url='https://api.allorigins.win/raw?url='+encodeURIComponent(
   `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?period1=${start}&period2=${now}&interval=1d`);
  const data=await fetch(url).then(r=>r.json());
  const r=data.chart.result[0]; return r.timestamp.map((t,i)=>({close:r.indicators.adjclose[0].adjclose[i]}));
}

/* ---------- calc ---------- */
const CAGR=(s,e,y)=>(!s||!e||y<=0)?null:Math.pow(e/s,1/y)-1;
/* ---------- main ---------- */
async function load(){
  const params=new URLSearchParams(location.search);
  const symbol=params.get('symbol')||'AAPL';
  document.getElementById('stock-symbol').textContent=symbol;

  try{
    const indian=isIndian(symbol),cur=indian?'â‚¹':'$';
    /* quote */
    const q= indian?await getQuoteYahoo(symbol):await getQuote(symbol);
    update('price', q.close, {cur});
    update('change',q.change,{cur});
    update('change-percent',q.percent_change/100,{pct:true});
    update('open',q.open,{cur});update('high',q.high,{cur});
    update('low', q.low ,{cur});update('volume',q.volume?.toLocaleString());

    /* CAGR from history */
    const hist= indian?await getHistYahoo(symbol):await getHist(symbol);
    if(hist.length){
      const priceNow=hist.at(-1).close;
      const day=252;
      [[1,1*day],[3,3*day],[5,5*day],[10,10*day],[15,15*day]].forEach(([yr,idx])=>{
        if(hist.length>idx){
          const cagr=CAGR(hist[hist.length-1-idx].close,priceNow,yr);
          update(`price-cagr-${yr}y`,cagr,{pct:true});
        }
      });
    }
    document.getElementById('source').textContent= indian?
       'Yahoo Finance (Indian price only)' :
       'Pre-fetched JSON (API key kept in GitHub Secrets)';
    document.getElementById('loading').style.display='none';
    document.getElementById('content').style.display='block';
  }catch(err){
    document.getElementById('loading').style.display='none';
    const e=document.getElementById('error');
    e.textContent='Error: '+err.message; e.style.display='block';
  }
}
window.onload=load;
</script>
</body>
</html>
