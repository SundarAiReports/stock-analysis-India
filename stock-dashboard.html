<!DOCTYPE html>
<html>
<head>
  <title>Stock Dashboard</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    .header { background: #222; color: white; padding: 20px; border-radius: 8px; text-align: center; }
    .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
    .metric-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .metric-card h3 { margin: 0 0 15px 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
    .metric-row { display: flex; justify-content: space-between; margin: 10px 0; padding: 8px 0; border-bottom: 1px solid #eee; }
    .metric-label { font-weight: bold; color: #666; }
    .metric-value { color: #333; }
    .positive { color: #28a745; font-weight: bold; }
    .negative { color: #dc3545; font-weight: bold; }
    .loading { text-align: center; color: #666; padding: 40px; }
    .error { text-align: center; color: #dc3545; padding: 20px; }
    .price-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
    .price-stat { background: #e9ecef; padding: 15px; border-radius: 5px; text-align: center; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 id="stock-symbol">Loading...</h1>
      <p id="company-name">&nbsp;</p>
      <p id="source" style="font-size: 12px; opacity: 0.8;"></p>
    </div>
    
    <div id="loading" class="loading">Fetching comprehensive stock data...</div>
    <div id="error" class="error" style="display:none;"></div>
    
    <div id="content" style="display:none;">
      <!-- Current Price Stats -->
      <div class="metric-card">
        <h3>Current Market Data</h3>
        <div class="price-stats">
          <div class="price-stat">Price: <strong id="price">-</strong></div>
          <div class="price-stat">Change: <strong id="change">-</strong></div>
          <div class="price-stat">Change %: <strong id="change-percent">-</strong></div>
          <div class="price-stat">Open: <strong id="open">-</strong></div>
          <div class="price-stat">High: <strong id="high">-</strong></div>
          <div class="price-stat">Low: <strong id="low">-</strong></div>
          <div class="price-stat">Volume: <strong id="volume">-</strong></div>
        </div>
      </div>

      <div class="metrics-grid">
        <!-- Dividend Information -->
        <div class="metric-card">
          <h3>ðŸ’° Dividend Information</h3>
          <div class="metric-row">
            <span class="metric-label">Current Dividend Yield:</span>
            <span class="metric-value" id="dividend-yield">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Annual Dividend Amount:</span>
            <span class="metric-value" id="dividend-amount">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Ex-Dividend Date:</span>
            <span class="metric-value" id="ex-dividend-date">-</span>
          </div>
        </div>

        <!-- Stock Price CAGR -->
        <div class="metric-card">
          <h3>ðŸ“ˆ Stock Price CAGR</h3>
          <div class="metric-row">
            <span class="metric-label">1 Year CAGR:</span>
            <span class="metric-value" id="price-cagr-1y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">3 Year CAGR:</span>
            <span class="metric-value" id="price-cagr-3y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">5 Year CAGR:</span>
            <span class="metric-value" id="price-cagr-5y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">10 Year CAGR:</span>
            <span class="metric-value" id="price-cagr-10y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">15 Year CAGR:</span>
            <span class="metric-value" id="price-cagr-15y">-</span>
          </div>
        </div>

        <!-- EPS Growth -->
        <div class="metric-card">
          <h3>ðŸ’¡ EPS Growth Rates</h3>
          <div class="metric-row">
            <span class="metric-label">Current EPS:</span>
            <span class="metric-value" id="current-eps">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">1 Year EPS Growth:</span>
            <span class="metric-value" id="eps-growth-1y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">3 Year EPS CAGR:</span>
            <span class="metric-value" id="eps-cagr-3y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">5 Year EPS CAGR:</span>
            <span class="metric-value" id="eps-cagr-5y">-</span>
          </div>
        </div>

        <!-- Free Cash Flow -->
        <div class="metric-card">
          <h3>ðŸ’µ Free Cash Flow</h3>
          <div class="metric-row">
            <span class="metric-label">Current FCF:</span>
            <span class="metric-value" id="current-fcf">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">1 Year FCF Growth:</span>
            <span class="metric-value" id="fcf-growth-1y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">3 Year FCF CAGR:</span>
            <span class="metric-value" id="fcf-cagr-3y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">5 Year FCF CAGR:</span>
            <span class="metric-value" id="fcf-cagr-5y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">10 Year FCF CAGR:</span>
            <span class="metric-value" id="fcf-cagr-10y">-</span>
          </div>
        </div>

        <!-- Revenue -->
        <div class="metric-card">
          <h3>ðŸ“Š Revenue Growth</h3>
          <div class="metric-row">
            <span class="metric-label">Current Revenue:</span>
            <span class="metric-value" id="current-revenue">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">1 Year Revenue Growth:</span>
            <span class="metric-value" id="revenue-growth-1y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">3 Year Revenue CAGR:</span>
            <span class="metric-value" id="revenue-cagr-3y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">5 Year Revenue CAGR:</span>
            <span class="metric-value" id="revenue-cagr-5y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">10 Year Revenue CAGR:</span>
            <span class="metric-value" id="revenue-cagr-10y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">15 Year Revenue CAGR:</span>
            <span class="metric-value" id="revenue-cagr-15y">-</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
  // Inline all functions to avoid module loading issues
  const API_KEY = '513N9J95UV8ZFFT1';
  const CACHE = {};
  
  async function avCall(params) {
    const cacheKey = params;
    if (CACHE[cacheKey] && Date.now() - CACHE[cacheKey].timestamp < 300000) {
      return CACHE[cacheKey].data;
    }
    
    const url = `https://www.alphavantage.co/query?apikey=${API_KEY}&${params}`;
    const response = await fetch(url);
    const data = await response.json();
    
    if (data.Note) throw new Error('Alpha Vantage rate limit reached');
    if (data.Information) throw new Error(data.Information);
    
    CACHE[cacheKey] = { data, timestamp: Date.now() };
    return data;
  }
  
  async function getCompanyOverview(symbol) {
    return await avCall(`function=OVERVIEW&symbol=${symbol}`);
  }
  
  async function getIncomeStatement(symbol) {
    return await avCall(`function=INCOME_STATEMENT&symbol=${symbol}`);
  }
  
  async function getCashFlow(symbol) {
    return await avCall(`function=CASH_FLOW&symbol=${symbol}`);
  }
  
  async function getHistoricalPrices(symbol) {
    const data = await avCall(`function=TIME_SERIES_DAILY_ADJUSTED&symbol=${symbol}&outputsize=full`);
    return data['Time Series (Daily)'];
  }
  
  async function globalQuote(symbol) {
    const data = await avCall(`function=GLOBAL_QUOTE&symbol=${symbol}`);
    return data['Global Quote'];
  }
  
  function calculateCAGR(startValue, endValue, years) {
    if (!startValue || !endValue || years <= 0) return null;
    return Math.pow(endValue / startValue, 1 / years) - 1;
  }
  
  function extractAnnualData(statements, field) {
    const annualReports = statements.annualReports || [];
    return annualReports.map(report => ({
      date: report.fiscalDateEnding,
      value: parseFloat(report[field]) || 0
    })).sort((a, b) => new Date(b.date) - new Date(a.date));
  }
  
  function calculateGrowthCAGR(data, years) {
    if (data.length < years + 1) return null;
    const current = data[0].value;
    const historical = data[years].value;
    return calculateCAGR(historical, current, years);
  }
  
  function formatCurrency(value, currency = '$') {
    if (!value || isNaN(value)) return '-';
    return currency + Number(value).toLocaleString(undefined, {maximumFractionDigits: 2});
  }
  
  function formatPercentage(value) {
    if (!value || isNaN(value)) return '-';
    const formatted = (value * 100).toFixed(2) + '%';
    return value >= 0 ? '+' + formatted : formatted;
  }
  
  function formatLargeNumber(value, currency = '$') {
    if (!value || isNaN(value)) return '-';
    const absValue = Math.abs(value);
    let formatted;
    
    if (absValue >= 1e12) formatted = (value / 1e12).toFixed(2) + 'T';
    else if (absValue >= 1e9) formatted = (value / 1e9).toFixed(2) + 'B';
    else if (absValue >= 1e6) formatted = (value / 1e6).toFixed(2) + 'M';
    else if (absValue >= 1e3) formatted = (value / 1e3).toFixed(2) + 'K';
    else formatted = value.toFixed(2);
    
    return currency + formatted;
  }
  
  function updateElement(id, value, isPercentage = false, isCurrency = false, currency = '$') {
    const element = document.getElementById(id);
    if (!element) return;
    
    if (isCurrency) {
      element.textContent = formatLargeNumber(value, currency);
    } else if (isPercentage) {
      element.textContent = formatPercentage(value);
      element.className = value >= 0 ? 'positive' : 'negative';
    } else {
      element.textContent = value || '-';
    }
  }
  
  async function loadStockData(symbol) {
    try {
      console.log('Loading data for:', symbol);
      document.getElementById('loading').textContent = `Loading data for ${symbol}...`;
      
      const currency = '$';
      
      // Get current quote
      const quote = await globalQuote(symbol);
      console.log('Quote data:', quote);
      
      const currentData = {
        price: parseFloat(quote['05. price']),
        change: parseFloat(quote['09. change']),
        changePercent: parseFloat(quote['10. change percent'].replace('%', '')),
        open: parseFloat(quote['02. open']),
        high: parseFloat(quote['03. high']),
        low: parseFloat(quote['04. low']),
        volume: parseInt(quote['06. volume'])
      };
      
      // Update current price display
      document.getElementById('price').textContent = formatCurrency(currentData.price, currency);
      updateElement('change', currentData.change, false, true, currency);
      updateElement('change-percent', currentData.changePercent / 100, true);
      updateElement('open', currentData.open, false, true, currency);
      updateElement('high', currentData.high, false, true, currency);
      updateElement('low', currentData.low, false, true, currency);
      updateElement('volume', currentData.volume?.toLocaleString());
  
      // Get fundamental data
      console.log('Fetching fundamental data...');
      const overview = await getCompanyOverview(symbol);
      console.log('Overview data:', overview);
      
      // Update dividend information
      updateElement('dividend-yield', overview.DividendYield || 'N/A');
      updateElement('dividend-amount', overview.DividendPerShare, false, true, currency);
      updateElement('ex-dividend-date', overview.ExDividendDate || 'N/A');
      
      // Get historical data for CAGR calculations
      const historicalPrices = await getHistoricalPrices(symbol);
      console.log('Historical prices sample:', Object.keys(historicalPrices).slice(0, 5));
      
      // Calculate price CAGR manually
      const priceData = Object.keys(historicalPrices).sort().reverse();
      const currentPrice = parseFloat(historicalPrices[priceData[0]]['5. adjusted close']);
      
      [1, 3, 5, 10, 15].forEach(years => {
        const targetIndex = Math.min(years * 252, priceData.length - 1); // ~252 trading days per year
        if (targetIndex < priceData.length) {
          const historicalPrice = parseFloat(historicalPrices[priceData[targetIndex]]['5. adjusted close']);
          const cagr = calculateCAGR(historicalPrice, currentPrice, years);
          updateElement(`price-cagr-${years}y`, cagr, true);
          console.log(`${years}Y CAGR:`, cagr);
        }
      });
  
      // Get EPS data
      const incomeStatement = await getIncomeStatement(symbol);
      console.log('Income statement sample:', incomeStatement);
      
      const epsData = extractAnnualData(incomeStatement, 'reportedEPS');
      console.log('EPS data:', epsData);
      
      if (epsData.length > 0) {
        updateElement('current-eps', epsData[0]?.value, false, true, currency);
        [1, 3, 5].forEach(years => {
          const growth = calculateGrowthCAGR(epsData, years);
          updateElement(`eps-${years === 1 ? 'growth-1y' : `cagr-${years}y`}`, growth, true);
        });
      }
  
      // Get cash flow data
      const cashFlow = await getCashFlow(symbol);
      const fcfData = extractAnnualData(cashFlow, 'operatingCashflow');
      
      if (fcfData.length > 0) {
        updateElement('current-fcf', fcfData[0]?.value, false, true, currency);
        [1, 3, 5, 10].forEach(years => {
          const growth = calculateGrowthCAGR(fcfData, years);
          updateElement(`fcf-${years === 1 ? 'growth-1y' : `cagr-${years}y`}`, growth, true);
        });
      }
  
      // Get revenue data
      const revenueData = extractAnnualData(incomeStatement, 'totalRevenue');
      
      if (revenueData.length > 0) {
        updateElement('current-revenue', revenueData[0]?.value, false, true, currency);
        [1, 3, 5, 10, 15].forEach(years => {
          const growth = calculateGrowthCAGR(revenueData, years);
          updateElement(`revenue-${years === 1 ? 'growth-1y' : `cagr-${years}y`}`, growth, true);
        });
      }
  
      document.getElementById('loading').style.display = 'none';
      document.getElementById('content').style.display = 'block';
      document.getElementById('source').textContent = 'Data source: Alpha Vantage';
      
      console.log('Data loading completed successfully');
      
    } catch (error) {
      console.error('Error loading stock data:', error);
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'block';
      document.getElementById('error').textContent = `Error loading data: ${error.message}`;
    }
  }
  
  async function main() {
    const urlParams = new URLSearchParams(window.location.search);
    const symbol = urlParams.get('symbol') || 'AAPL';
    
    document.getElementById('stock-symbol').textContent = symbol;
    document.title = `${symbol} - Stock Analysis Dashboard`;
    
    await loadStockData(symbol);
  }
  
  window.onload = main;
  </script>
</body>
</html>
