<!DOCTYPE html>
<html>
<head>
  <title>Stock Dashboard</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    .header { background: #222; color: white; padding: 20px; border-radius: 8px; text-align: center; }
    .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
    .metric-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .metric-card h3 { margin: 0 0 15px 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
    .metric-row { display: flex; justify-content: space-between; margin: 10px 0; padding: 8px 0; border-bottom: 1px solid #eee; }
    .metric-label { font-weight: bold; color: #666; }
    .metric-value { color: #333; }
    .positive { color: #28a745; font-weight: bold; }
    .negative { color: #dc3545; font-weight: bold; }
    .loading { text-align: center; color: #666; padding: 40px; }
    .error { text-align: center; color: #dc3545; padding: 20px; }
    .price-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
    .price-stat { background: #e9ecef; padding: 15px; border-radius: 5px; text-align: center; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 id="stock-symbol">Loading...</h1>
      <p id="company-name">&nbsp;</p>
      <p id="source" style="font-size: 12px; opacity: 0.8;"></p>
    </div>
    
    <div id="loading" class="loading">Fetching comprehensive financial data from TwelveData...</div>
    <div id="error" class="error" style="display:none;"></div>
    
    <div id="content" style="display:none;">
      <!-- Current Price Stats -->
      <div class="metric-card">
        <h3>Current Market Data</h3>
        <div class="price-stats">
          <div class="price-stat">Price: <strong id="price">-</strong></div>
          <div class="price-stat">Change: <strong id="change">-</strong></div>
          <div class="price-stat">Change %: <strong id="change-percent">-</strong></div>
          <div class="price-stat">Open: <strong id="open">-</strong></div>
          <div class="price-stat">High: <strong id="high">-</strong></div>
          <div class="price-stat">Low: <strong id="low">-</strong></div>
          <div class="price-stat">Volume: <strong id="volume">-</strong></div>
        </div>
      </div>

      <div class="metrics-grid">
        <!-- Dividend Information -->
        <div class="metric-card">
          <h3>ðŸ’° Dividend Information</h3>
          <div class="metric-row">
            <span class="metric-label">Current Dividend Yield:</span>
            <span class="metric-value" id="dividend-yield">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Annual Dividend Amount:</span>
            <span class="metric-value" id="dividend-amount">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Ex-Dividend Date:</span>
            <span class="metric-value" id="ex-dividend-date">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Dividend CAGR (3Y):</span>
            <span class="metric-value" id="dividend-cagr-3y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Dividend CAGR (5Y):</span>
            <span class="metric-value" id="dividend-cagr-5y">-</span>
          </div>
        </div>

        <!-- Stock Price CAGR -->
        <div class="metric-card">
          <h3>ðŸ“ˆ Stock Price CAGR</h3>
          <div class="metric-row">
            <span class="metric-label">1 Year CAGR:</span>
            <span class="metric-value" id="price-cagr-1y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">3 Year CAGR:</span>
            <span class="metric-value" id="price-cagr-3y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">5 Year CAGR:</span>
            <span class="metric-value" id="price-cagr-5y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">10 Year CAGR:</span>
            <span class="metric-value" id="price-cagr-10y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">15 Year CAGR:</span>
            <span class="metric-value" id="price-cagr-15y">-</span>
          </div>
        </div>

        <!-- EPS Growth -->
        <div class="metric-card">
          <h3>ðŸ’¡ EPS Growth Rates</h3>
          <div class="metric-row">
            <span class="metric-label">Current EPS:</span>
            <span class="metric-value" id="current-eps">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">1 Year EPS Growth:</span>
            <span class="metric-value" id="eps-growth-1y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">3 Year EPS CAGR:</span>
            <span class="metric-value" id="eps-cagr-3y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">5 Year EPS CAGR:</span>
            <span class="metric-value" id="eps-cagr-5y">-</span>
          </div>
        </div>

        <!-- Free Cash Flow -->
        <div class="metric-card">
          <h3>ðŸ’µ Free Cash Flow</h3>
          <div class="metric-row">
            <span class="metric-label">Current FCF:</span>
            <span class="metric-value" id="current-fcf">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">1 Year FCF Growth:</span>
            <span class="metric-value" id="fcf-growth-1y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">3 Year FCF CAGR:</span>
            <span class="metric-value" id="fcf-cagr-3y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">5 Year FCF CAGR:</span>
            <span class="metric-value" id="fcf-cagr-5y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">10 Year FCF CAGR:</span>
            <span class="metric-value" id="fcf-cagr-10y">-</span>
          </div>
        </div>

        <!-- Revenue -->
        <div class="metric-card">
          <h3>ðŸ“Š Revenue Growth</h3>
          <div class="metric-row">
            <span class="metric-label">Current Revenue:</span>
            <span class="metric-value" id="current-revenue">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">1 Year Revenue Growth:</span>
            <span class="metric-value" id="revenue-growth-1y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">3 Year Revenue CAGR:</span>
            <span class="metric-value" id="revenue-cagr-3y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">5 Year Revenue CAGR:</span>
            <span class="metric-value" id="revenue-cagr-5y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">10 Year Revenue CAGR:</span>
            <span class="metric-value" id="revenue-cagr-10y">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">15 Year Revenue CAGR:</span>
            <span class="metric-value" id="revenue-cagr-15y">-</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const TD_API_KEY = '9ab46115418746939c700a4735fffbbb'; // Replace with your key
    const CACHE = {};

    async function tdCall(endpoint, params = {}) {
      const paramString = new URLSearchParams({...params, apikey: TD_API_KEY}).toString();
      const cacheKey = `${endpoint}?${paramString}`;
      
      if (CACHE[cacheKey] && Date.now() - CACHE[cacheKey].timestamp < 300000) {
        return CACHE[cacheKey].data;
      }
      
      const url = `https://api.twelvedata.com/${endpoint}?${paramString}`;
      console.log('Fetching:', url);
      
      const response = await fetch(url);
      const data = await response.json();
      
      if (data.status === 'error') {
        throw new Error(data.message || 'TwelveData API error');
      }
      
      CACHE[cacheKey] = { data, timestamp: Date.now() };
      return data;
    }

    function calculateCAGR(startValue, endValue, years) {
      if (!startValue || !endValue || years <= 0) return null;
      return Math.pow(endValue / startValue, 1 / years) - 1;
    }

    function formatCurrency(value, currency = '$', symbol = '') {
      if (!value || isNaN(value)) return '-';
      const absValue = Math.abs(value);
      let formatted;
      
      if (absValue >= 1e12) formatted = (value / 1e12).toFixed(2) + 'T';
      else if (absValue >= 1e9) formatted = (value / 1e9).toFixed(2) + 'B';
      else if (absValue >= 1e6) formatted = (value / 1e6).toFixed(2) + 'M';
      else if (absValue >= 1e3) formatted = (value / 1e3).toFixed(2) + 'K';
      else formatted = value.toFixed(2);
      
      return currency + formatted;
    }

    function formatPercentage(value) {
      if (!value || isNaN(value)) return '-';
      const formatted = (value * 100).toFixed(2) + '%';
      return value >= 0 ? '+' + formatted : formatted;
    }

    function updateElement(id, value, isPercentage = false, isCurrency = false, currency = '$') {
      const element = document.getElementById(id);
      if (!element) return;
      
      if (isCurrency) {
        element.textContent = formatCurrency(value, currency);
      } else if (isPercentage) {
        element.textContent = formatPercentage(value);
        element.className = value >= 0 ? 'positive' : 'negative';
      } else {
        element.textContent = value || '-';
      }
    }

    async function loadStockData(symbol) {
      try {
        console.log('Loading comprehensive data for:', symbol);
        document.getElementById('loading').textContent = `Loading data for ${symbol}...`;
        
        const currency = symbol.includes('.NS') ? 'â‚¹' : '$';
        
        // 1. Get Current Quote
        console.log('Fetching quote...');
        const quote = await tdCall('quote', { symbol });
        
        document.getElementById('price').textContent = formatCurrency(parseFloat(quote.close), currency);
        updateElement('change', parseFloat(quote.change), false, true, currency);
        updateElement('change-percent', parseFloat(quote.percent_change) / 100, true);
        updateElement('open', parseFloat(quote.open), false, true, currency);
        updateElement('high', parseFloat(quote.high), false, true, currency);
        updateElement('low', parseFloat(quote.low), false, true, currency);
        updateElement('volume', parseInt(quote.volume)?.toLocaleString());

        // Skip fundamental data for Indian stocks
        if (symbol.includes('.NS') || symbol.includes('.BO')) {
          document.getElementById('source').textContent = 'Data source: TwelveData (Price data only for Indian stocks)';
          document.getElementById('loading').style.display = 'none';
          document.getElementById('content').style.display = 'block';
          return;
        }

        // 2. Get Historical Price Data for CAGR
        console.log('Fetching historical prices...');
        const historicalData = await tdCall('time_series', { 
          symbol, 
          interval: '1day', 
          outputsize: 5000 
        });
        
        if (historicalData.values) {
          const prices = historicalData.values.reverse(); // oldest to newest
          const currentPrice = parseFloat(prices[prices.length - 1].close);
          
          // Calculate Price CAGR
          [1, 3, 5, 10, 15].forEach(years => {
            const daysBack = years * 252; // trading days
            if (prices.length > daysBack) {
              const historicalPrice = parseFloat(prices[prices.length - 1 - daysBack].close);
              const cagr = calculateCAGR(historicalPrice, currentPrice, years);
              updateElement(`price-cagr-${years}y`, cagr, true);
            }
          });
        }

        // 3. Get Dividend Data
        console.log('Fetching dividends...');
        try {
          const dividends = await tdCall('dividends', { symbol });
          if (dividends && dividends.length > 0) {
            const latestDiv = dividends[0];
            const annualDividend = dividends.slice(0, 4).reduce((sum, div) => sum + parseFloat(div.amount || 0), 0);
            const dividendYield = (annualDividend / currentPrice) * 100;
            
            updateElement('dividend-yield', dividendYield + '%');
            updateElement('dividend-amount', annualDividend, false, true, currency);
            updateElement('ex-dividend-date', latestDiv.ex_date || 'N/A');
            
            // Calculate Dividend CAGR
            if (dividends.length >= 36) { // 3 years of monthly data
              const div3YearsAgo = parseFloat(dividends[35]?.amount || 0);
              const divCagr3Y = calculateCAGR(div3YearsAgo, parseFloat(latestDiv.amount), 3);
              updateElement('dividend-cagr-3y', divCagr3Y, true);
            }
            
            if (dividends.length >= 60) { // 5 years
              const div5YearsAgo = parseFloat(dividends[59]?.amount || 0);
              const divCagr5Y = calculateCAGR(div5YearsAgo, parseFloat(latestDiv.amount), 5);
              updateElement('dividend-cagr-5y', divCagr5Y, true);
            }
          }
        } catch (divError) {
          console.log('Dividend data not available:', divError.message);
        }

        // 4. Get Earnings Data
        console.log('Fetching earnings...');
        try {
          const earnings = await tdCall('earnings', { symbol });
          if (earnings && earnings.length > 0) {
            const latestEarnings = earnings[0];
            updateElement('current-eps', latestEarnings.eps_actual, false, true, currency);
            
            // Calculate EPS growth
            if (earnings.length >= 4) { // 1 year of quarterly data
              const eps1YearAgo = parseFloat(earnings[3]?.eps_actual || 0);
              const currentEPS = parseFloat(latestEarnings.eps_actual || 0);
              const epsGrowth1Y = calculateCAGR(eps1YearAgo, currentEPS, 1);
              updateElement('eps-growth-1y', epsGrowth1Y, true);
            }
            
            // 3 and 5 year EPS CAGR
            [3, 5].forEach(years => {
              const quartersBack = years * 4;
              if (earnings.length >= quartersBack) {
                const epsHistorical = parseFloat(earnings[quartersBack - 1]?.eps_actual || 0);
                const cagr = calculateCAGR(epsHistorical, parseFloat(latestEarnings.eps_actual), years);
                updateElement(`eps-cagr-${years}y`, cagr, true);
              }
            });
          }
        } catch (earningsError) {
          console.log('Earnings data not available:', earningsError.message);
        }

        // 5. Get Financial Statements (Cash Flow & Income Statement)
        console.log('Fetching financial statements...');
        try {
          // Cash Flow Statement
          const cashFlow = await tdCall('cash_flow', { symbol });
          if (cashFlow && cashFlow.length > 0) {
            const latestCF = cashFlow[0];
            const fcf = parseFloat(latestCF.free_cash_flow || latestCF.operating_cash_flow || 0);
            updateElement('current-fcf', fcf, false, true, currency);
            
            // FCF Growth CAGR
            [1, 3, 5, 10].forEach(years => {
              if (cashFlow.length > years) {
                const historicalFCF = parseFloat(cashFlow[years]?.free_cash_flow || cashFlow[years]?.operating_cash_flow || 0);
                const cagr = calculateCAGR(historicalFCF, fcf, years);
                updateElement(`fcf-${years === 1 ? 'growth-1y' : `cagr-${years}y`}`, cagr, true);
              }
            });
          }

          // Income Statement for Revenue
          const incomeStatement = await tdCall('income_statement', { symbol });
          if (incomeStatement && incomeStatement.length > 0) {
            const latestIncome = incomeStatement[0];
            const revenue = parseFloat(latestIncome.total_revenue || 0);
            updateElement('current-revenue', revenue, false, true, currency);
            
            // Revenue Growth CAGR
            [1, 3, 5, 10, 15].forEach(years => {
              if (incomeStatement.length > years) {
                const historicalRevenue = parseFloat(incomeStatement[years]?.total_revenue || 0);
                const cagr = calculateCAGR(historicalRevenue, revenue, years);
                updateElement(`revenue-${years === 1 ? 'growth-1y' : `cagr-${years}y`}`, cagr, true);
              }
            });
          }
        } catch (statementsError) {
          console.log('Financial statements not available:', statementsError.message);
        }

        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';
        document.getElementById('source').textContent = 'Data source: TwelveData API';
        
        console.log('Data loading completed successfully');
        
      } catch (error) {
        console.error('Error loading stock data:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
        document.getElementById('error').textContent = `Error loading data: ${error.message}`;
      }
    }

    async function main() {
      const urlParams = new URLSearchParams(window.location.search);
      const symbol = urlParams.get('symbol') || 'AAPL';
      
      document.getElementById('stock-symbol').textContent = symbol;
      document.title = `${symbol} - Comprehensive Stock Analysis`;
      
      await loadStockData(symbol);
    }

    window.onload = main;
  </script>
</body>
</html>
