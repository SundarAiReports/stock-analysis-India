<!DOCTYPE html>
<html>
<head>
    <title>Stock Analysis Dashboard</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 20px; background-color: #f8f9fa; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 20px; }
        .stock-title { font-size: 2.5em; margin: 0; }
        .section { background: white; margin: 20px 0; padding: 25px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .positive { color: #28a745; font-weight: bold; }
        .negative { color: #dc3545; font-weight: bold; }
        .success-banner { background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin: 20px 0; }
        .error-banner { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin: 20px 0; }
        .metric-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .metric-card { background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; }
        .metric-value { font-size: 1.5em; font-weight: bold; color: #667eea; }
        .metric-label { color: #6c757d; font-size: 0.9em; margin-top: 5px; }
        .debug-info { background: #fff3cd; color: #856404; padding: 15px; border-radius: 8px; margin: 20px 0; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="stock-title" id="stock-name">Loading...</h1>
            <p id="stock-company">Fetching stock information...</p>
        </div>
        
        <div id="debug-info" class="debug-info">
            <h4>üîç Debug Information:</h4>
            <div id="debug-log">Initializing...</div>
        </div>
        
        <div id="stock-content">
            <div class="section">
                <h3>‚è≥ Loading Stock Data...</h3>
                <p>Please wait while we fetch real-time data...</p>
            </div>
        </div>
    </div>
    
    <script>
        // Add your actual API keys here
        const API_KEYS = {
            alphavantage: '513N9J95UV8ZFFT1',
            finnhub: 'd1ud7jpr01qp7ee2uqagd1ud7jpr01qp7ee2uqb0',
            twelvedata: '9ab46115418746939c700a4735fffbbb'
        };

        function debugLog(message) {
            console.log(message);
            const debugDiv = document.getElementById('debug-log');
            debugDiv.innerHTML += '<br>' + new Date().toLocaleTimeString() + ': ' + message;
        }

        function getStockSymbol() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('symbol') || 'INDUSINDBK.NS';
        }

        async function fetchFromAlphaVantage(symbol) {
            debugLog(`Trying Alpha Vantage for ${symbol}...`);
            try {
                const apiKey = API_KEYS.alphavantage;
                if (apiKey === '513N9J95UV8ZFFT1') {
                    throw new Error('Please set your Alpha Vantage API key');
                }

                const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${513N9J95UV8ZFFT1}`;
                debugLog(`Alpha Vantage URL: ${url}`);
                
                const response = await fetch(url);
                const data = await response.json();
                debugLog(`Alpha Vantage response: ${JSON.stringify(data)}`);

                if (data['Global Quote'] && Object.keys(data['Global Quote']).length > 0) {
                    const quote = data['Global Quote'];
                    const currentPrice = parseFloat(quote['05. price']);
                    const change = parseFloat(quote['09. change']);
                    const changePercent = parseFloat(quote['10. change percent'].replace('%', ''));

                    return {
                        success: true,
                        source: 'Alpha Vantage',
                        symbol: symbol,
                        currentPrice: currentPrice,
                        change: change,
                        changePercent: changePercent,
                        changeClass: changePercent >= 0 ? 'positive' : 'negative',
                        volume: parseInt(quote['06. volume']),
                        high: parseFloat(quote['03. high']),
                        low: parseFloat(quote['04. low'])
                    };
                } else if (data['Note']) {
                    throw new Error('Alpha Vantage API limit reached');
                } else {
                    throw new Error('No data in Alpha Vantage response');
                }
            } catch (error) {
                debugLog(`Alpha Vantage failed: ${error.message}`);
                return null;
            }
        }

        async function fetchFromFinnhub(symbol) {
            debugLog(`Trying Finnhub for ${symbol}...`);
            try {
                const apiKey = API_KEYS.finnhub;
                if (apiKey === 'd1ud7jpr01qp7ee2uqagd1ud7jpr01qp7ee2uqb0') {
                    throw new Error('Please set your Finnhub API key');
                }

                const url = `https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${d1ud7jpr01qp7ee2uqagd1ud7jpr01qp7ee2uqb0}`;
                debugLog(`Finnhub URL: ${url}`);
                
                const response = await fetch(url);
                const data = await response.json();
                debugLog(`Finnhub response: ${JSON.stringify(data)}`);

                if (data.c && data.c > 0) {
                    const currentPrice = data.c;
                    const change = data.d;
                    const changePercent = data.dp;

                    return {
                        success: true,
                        source: 'Finnhub',
                        symbol: symbol,
                        currentPrice: currentPrice,
                        change: change,
                        changePercent: changePercent,
                        changeClass: changePercent >= 0 ? 'positive' : 'negative',
                        high: data.h,
                        low: data.l,
                        previousClose: data.pc
                    };
                } else {
                    throw new Error('No valid data from Finnhub');
                }
            } catch (error) {
                debugLog(`Finnhub failed: ${error.message}`);
                return null;
            }
        }

        async function fetchFrom12Data(symbol) {
            debugLog(`Trying 12Data for ${symbol}...`);
            try {
                const apiKey = API_KEYS.twelvedata;
                if (apiKey === '9ab46115418746939c700a4735fffbbb') {
                    throw new Error('Please set your 12Data API key');
                }

                const url = `https://api.twelvedata.com/quote?symbol=${symbol}&apikey=${9ab46115418746939c700a4735fffbbb}`;
                debugLog(`12Data URL: ${url}`);
                
                const response = await fetch(url);
                const data = await response.json();
                debugLog(`12Data response: ${JSON.stringify(data)}`);

                if (data.close) {
                    const currentPrice = parseFloat(data.close);
                    const change = parseFloat(data.change);
                    const changePercent = parseFloat(data.percent_change);

                    return {
                        success: true,
                        source: '12Data',
                        symbol: symbol,
                        currentPrice: currentPrice,
                        change: change,
                        changePercent: changePercent,
                        changeClass: changePercent >= 0 ? 'positive' : 'negative',
                        high: parseFloat(data.high),
                        low: parseFloat(data.low),
                        volume: parseInt(data.volume)
                    };
                } else {
                    throw new Error('No valid data from 12Data');
                }
            } catch (error) {
                debugLog(`12Data failed: ${error.message}`);
                return null;
            }
        }

        async function fetchStockData(symbol) {
            debugLog(`Starting data fetch for ${symbol}`);
            
            // Try each API in sequence
            let result = await fetchFromAlphaVantage(symbol);
            if (result) return result;

            result = await fetchFromFinnhub(symbol);
            if (result) return result;

            result = await fetchFrom12Data(symbol);
            if (result) return result;

            // All APIs failed
            debugLog('All APIs failed to return data');
            return {
                success: false,
                symbol: symbol,
                error: 'All API sources failed to return data'
            };
        }

        function displayStock(stockData) {
            const symbol = stockData.symbol;
            document.getElementById('stock-name').textContent = symbol;
            document.getElementById('stock-company').textContent = `${symbol.replace('.NS', '')} Limited | NSE`;
            document.title = `Stock Analysis - ${symbol}`;

            if (stockData.success) {
                document.getElementById('stock-content').innerHTML = `
                    <div class="success-banner">
                        <strong>‚úÖ Live Data Successfully Loaded for ${symbol}</strong><br>
                        Data source: ${stockData.source}
                    </div>
                    
                    <div class="section">
                        <h2>üìä Current Market Data</h2>
                        <div class="metric-grid">
                            <div class="metric-card">
                                <div class="metric-value">‚Çπ${stockData.currentPrice?.toFixed(2) || 'N/A'}</div>
                                <div class="metric-label">Current Price</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value ${stockData.changeClass}">
                                    ${stockData.changePercent >= 0 ? '+' : ''}${stockData.changePercent?.toFixed(2) || 'N/A'}%
                                </div>
                                <div class="metric-label">Change %</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value ${stockData.changeClass}">
                                    ${stockData.change >= 0 ? '+' : ''}‚Çπ${stockData.change?.toFixed(2) || 'N/A'}
                                </div>
                                <div class="metric-label">Change Amount</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">‚Çπ${stockData.high?.toFixed(2) || 'N/A'}</div>
                                <div class="metric-label">Day High</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">‚Çπ${stockData.low?.toFixed(2) || 'N/A'}</div>
                                <div class="metric-label">Day Low</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${stockData.volume ? (stockData.volume/1000).toFixed(0) + 'K' : 'N/A'}</div>
                                <div class="metric-label">Volume</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2>üìà Analysis Summary</h2>
                        <p><strong>Symbol:</strong> ${symbol}</p>
                        <p><strong>Current Price:</strong> ‚Çπ${stockData.currentPrice?.toFixed(2)}</p>
                        <p><strong>Change:</strong> <span class="${stockData.changeClass}">‚Çπ${stockData.change?.toFixed(2)} (${stockData.changePercent?.toFixed(2)}%)</span></p>
                        <p><strong>Data Source:</strong> ${stockData.source}</p>
                        <p><strong>Last Updated:</strong> ${new Date().toLocaleString()}</p>
                    </div>
                `;
            } else {
                document.getElementById('stock-content').innerHTML = `
                    <div class="error-banner">
                        <h3>‚ö†Ô∏è Unable to Load Data for ${symbol}</h3>
                        <p><strong>Error:</strong> ${stockData.error}</p>
                        <p><strong>Troubleshooting:</strong></p>
                        <ul>
                            <li>Check if your API keys are set correctly</li>
                            <li>Verify the stock symbol is correct</li>
                            <li>Check API rate limits</li>
                            <li>See debug information above for details</li>
                        </ul>
                    </div>
                `;
            }
        }

        async function init() {
            const symbol = getStockSymbol();
            debugLog(`Initializing for symbol: ${symbol}`);
            
            const stockData = await fetchStockData(symbol);
            displayStock(stockData);
        }

        // Initialize when page loads
        window.onload = init;
    </script>
</body>
</html>
