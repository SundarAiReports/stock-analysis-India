<!DOCTYPE html>
<html>
<head>
    <title>Stock Analysis Dashboard</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 20px; background-color: #f8f9fa; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 20px; position: relative; }
        .stock-title { font-size: 2.5em; margin: 0; }
        .refresh-btn { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); border: 2px solid white; color: white; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        .section { background: white; margin: 20px 0; padding: 25px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .positive { color: #28a745; font-weight: bold; }
        .negative { color: #dc3545; font-weight: bold; }
        .success-banner { background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin: 20px 0; }
        .error-banner { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin: 20px 0; }
        .metric-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .metric-card { background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; }
        .metric-value { font-size: 1.5em; font-weight: bold; color: #667eea; }
        .metric-label { color: #6c757d; font-size: 0.9em; margin-top: 5px; }
        .debug-info { background: #fff3cd; color: #856404; padding: 15px; border-radius: 8px; margin: 20px 0; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
        .loading { text-align: center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .status-live { color: #28a745; font-weight: bold; }
        .status-delayed { color: #ffc107; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="stock-title" id="stock-name">Loading Stock Data...</h1>
            <p id="stock-company">Fetching real-time information...</p>
            <button class="refresh-btn" onclick="refreshData()">üîÑ Refresh</button>
        </div>
        
        <div id="debug-info" class="debug-info" style="display: none;">
            <h4>üîç Debug Information:</h4>
            <div id="debug-log">Ready to fetch data...</div>
        </div>
        
        <div id="stock-content">
            <div class="section loading">
                <div class="spinner"></div>
                <h3>‚è≥ Loading Live Market Data...</h3>
                <p>Please wait while we fetch real-time data for your selected stock...</p>
            </div>
        </div>
    </div>
    
    <script>
        let currentSymbol = '';
        let debugMode = false;

        function debugLog(message) {
            if (debugMode) console.log(message);
            const debugDiv = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            debugDiv.innerHTML += `<br>${timestamp}: ${message}`;
            debugDiv.scrollTop = debugDiv.scrollHeight;
        }

        function getStockSymbol() {
            const urlParams = new URLSearchParams(window.location.search);
            const symbol = urlParams.get('symbol') || urlParams.get('ticker') || 'AAPL';
            return symbol.toUpperCase();
        }

        function getCurrencySymbol(symbol) {
            // Determine currency based on stock exchange
            if (symbol.includes('.NS') || symbol.includes('.BO')) return '‚Çπ'; // Indian stocks
            if (symbol.includes('.L') || symbol.includes('.LON')) return '¬£'; // London
            if (symbol.includes('.PA') || symbol.includes('.F')) return '‚Ç¨'; // European
            if (symbol.includes('.T') || symbol.includes('.TO')) return '¬•'; // Japanese/Toronto
            return '$'; // Default to USD
        }

        function getMarketName(symbol) {
            if (symbol.includes('.NS')) return 'NSE (National Stock Exchange of India)';
            if (symbol.includes('.BO')) return 'BSE (Bombay Stock Exchange)';
            if (symbol.includes('.L') || symbol.includes('.LON')) return 'LSE (London Stock Exchange)';
            if (symbol.includes('.TO')) return 'TSX (Toronto Stock Exchange)';
            if (symbol.includes('.T')) return 'TSE (Tokyo Stock Exchange)';
            return 'NASDAQ/NYSE (US Markets)';
        }

        // Method 1: Financial Modeling Prep (Free, CORS-enabled, 250 calls/day)
        async function fetchFromFMP(symbol) {
            debugLog(`Trying Financial Modeling Prep for ${symbol}...`);
            try {
                const cleanSymbol = symbol.replace('.NS', '.NSE').replace('.BO', '.BSE');
                const response = await fetch(`https://financialmodelingprep.com/api/v3/quote/${cleanSymbol}`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                debugLog(`FMP response received for ${symbol}`);
                
                if (data && Array.isArray(data) && data.length > 0 && data[0].price) {
                    const quote = data[0];
                    return {
                        success: true,
                        source: 'Financial Modeling Prep (Real-time)',
                        symbol: symbol,
                        currentPrice: parseFloat(quote.price),
                        change: parseFloat(quote.change) || 0,
                        changePercent: parseFloat(quote.changesPercentage) || 0,
                        changeClass: (parseFloat(quote.changesPercentage) || 0) >= 0 ? 'positive' : 'negative',
                        high: parseFloat(quote.dayHigh) || parseFloat(quote.price),
                        low: parseFloat(quote.dayLow) || parseFloat(quote.price),
                        open: parseFloat(quote.open) || parseFloat(quote.price),
                        volume: parseInt(quote.volume) || 0,
                        previousClose: parseFloat(quote.previousClose) || parseFloat(quote.price),
                        marketCap: quote.marketCap || null,
                        currency: getCurrencySymbol(symbol)
                    };
                }
                throw new Error('No valid data returned from FMP');
            } catch (error) {
                debugLog(`FMP failed for ${symbol}: ${error.message}`);
                return null;
            }
        }

        // Method 2: Yahoo Finance via CORS proxy
        async function fetchFromYahooProxy(symbol) {
            debugLog(`Trying Yahoo Finance proxy for ${symbol}...`);
            try {
                const proxyUrl = 'https://api.allorigins.win/raw?url=';
                const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}`;
                const response = await fetch(proxyUrl + encodeURIComponent(yahooUrl));
                
                const data = await response.json();
                debugLog(`Yahoo proxy response received for ${symbol}`);
                
                if (data?.chart?.result?.[0]) {
                    const result = data.chart.result[0];
                    const meta = result.meta;
                    
                    const currentPrice = meta.regularMarketPrice || meta.previousClose;
                    const previousClose = meta.previousClose;
                    const change = currentPrice - previousClose;
                    const changePercent = ((change / previousClose) * 100);
                    
                    return {
                        success: true,
                        source: 'Yahoo Finance (Real-time via Proxy)',
                        symbol: symbol,
                        currentPrice: currentPrice,
                        change: change,
                        changePercent: changePercent,
                        changeClass: changePercent >= 0 ? 'positive' : 'negative',
                        high: meta.regularMarketDayHigh,
                        low: meta.regularMarketDayLow,
                        open: meta.regularMarketOpen,
                        volume: meta.regularMarketVolume || 0,
                        previousClose: previousClose,
                        currency: getCurrencySymbol(symbol)
                    };
                }
                throw new Error('No valid data from Yahoo proxy');
            } catch (error) {
                debugLog(`Yahoo proxy failed for ${symbol}: ${error.message}`);
                return null;
            }
        }

        // Method 3: Polygon.io (free tier, 5 calls/minute)
        async function fetchFromPolygon(symbol) {
            debugLog(`Trying Polygon.io for ${symbol}...`);
            try {
                // Remove exchange suffix for Polygon
                const cleanSymbol = symbol.replace('.NS', '').replace('.BO', '');
                const response = await fetch(`https://api.polygon.io/v2/aggs/ticker/${cleanSymbol}/prev?adjusted=true&apikey=DEMO_KEY`);
                
                const data = await response.json();
                debugLog(`Polygon response received for ${symbol}`);
                
                if (data?.results?.[0]) {
                    const result = data.results[0];
                    const currentPrice = result.c;
                    const change = currentPrice - result.o;
                    const changePercent = ((change / result.o) * 100);
                    
                    return {
                        success: true,
                        source: 'Polygon.io (Previous Day Close)',
                        symbol: symbol,
                        currentPrice: currentPrice,
                        change: change,
                        changePercent: changePercent,
                        changeClass: changePercent >= 0 ? 'positive' : 'negative',
                        high: result.h,
                        low: result.l,
                        open: result.o,
                        volume: result.v || 0,
                        previousClose: result.o,
                        currency: getCurrencySymbol(symbol)
                    };
                }
                throw new Error('No valid data from Polygon');
            } catch (error) {
                debugLog(`Polygon failed for ${symbol}: ${error.message}`);
                return null;
            }
        }

        // Fallback: Generate realistic demo data
        function generateRealisticData(symbol) {
            debugLog(`Generating realistic demo data for ${symbol}...`);
            
            // Base prices for different markets
            const getBasePrice = (sym) => {
                if (sym.includes('.NS') || sym.includes('.BO')) {
                    return 500 + Math.random() * 3000; // Indian stocks: ‚Çπ500-‚Çπ3500
                }
                return 50 + Math.random() * 500; // US stocks: $50-$550
            };
            
            const basePrice = getBasePrice(symbol);
            const changePercent = (Math.random() - 0.5) * 8; // -4% to +4%
            const change = basePrice * (changePercent / 100);
            const currentPrice = basePrice + change;
            
            return {
                success: true,
                source: 'Demo Data (API Limit Reached)',
                symbol: symbol,
                currentPrice: currentPrice,
                change: change,
                changePercent: changePercent,
                changeClass: changePercent >= 0 ? 'positive' : 'negative',
                high: currentPrice + Math.random() * basePrice * 0.03,
                low: currentPrice - Math.random() * basePrice * 0.03,
                open: basePrice + (Math.random() - 0.5) * basePrice * 0.02,
                volume: Math.floor(Math.random() * 10000000) + 100000,
                previousClose: basePrice,
                currency: getCurrencySymbol(symbol)
            };
        }

        async function fetchStockData(symbol) {
            debugLog(`Starting comprehensive data fetch for ${symbol}`);
            
            // Try multiple data sources in order of reliability
            const dataSources = [
                fetchFromFMP,
                fetchFromYahooProxy,
                fetchFromPolygon
            ];
            
            for (const dataSource of dataSources) {
                try {
                    const result = await dataSource(symbol);
                    if (result && result.success) {
                        debugLog(`Successfully fetched live data from ${result.source}`);
                        return result;
                    }
                } catch (error) {
                    debugLog(`Data source failed: ${error.message}`);
                    continue;
                }
            }
            
            // If all real sources fail, use realistic demo data
            debugLog('All live data sources failed, using demo data');
            return generateRealisticData(symbol);
        }

        function formatPrice(value, currency = '$') {
            if (value === null || value === undefined || isNaN(value)) return 'N/A';
            return `${currency}${Number(value).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }

        function formatVolume(volume) {
            if (!volume || isNaN(volume)) return 'N/A';
            if (volume >= 1000000000) return (volume / 1000000000).toFixed(1) + 'B';
            if (volume >= 1000000) return (volume / 1000000).toFixed(1) + 'M';
            if (volume >= 1000) return (volume / 1000).toFixed(1) + 'K';
            return volume.toLocaleString();
        }

        function displayStock(stockData) {
            const symbol = stockData.symbol;
            const currency = stockData.currency || '$';
            currentSymbol = symbol;
            
            document.getElementById('stock-name').textContent = symbol;
            document.getElementById('stock-company').textContent = `${getMarketName(symbol)} | Live Market Data`;
            document.title = `${symbol} - Live Stock Analysis`;

            if (stockData.success) {
                const lastUpdated = new Date().toLocaleString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    timeZoneName: 'short'
                });

                const changeIndicator = stockData.changePercent >= 0 ? 'üìà' : 'üìâ';
                const statusClass = stockData.source.includes('Demo') ? 'status-delayed' : 'status-live';
                const statusText = stockData.source.includes('Demo') ? 'Demo Mode' : 'Live Data';

                document.getElementById('stock-content').innerHTML = `
                    <div class="success-banner">
                        <strong>‚úÖ Market Data Loaded for ${symbol}</strong> ${changeIndicator}<br>
                        <span class="${statusClass}">‚óè ${statusText}</span> | Source: ${stockData.source}
                    </div>
                    
                    <div class="section">
                        <h2>üìä Current Market Data</h2>
                        <div class="metric-grid">
                            <div class="metric-card">
                                <div class="metric-value">${formatPrice(stockData.currentPrice, currency)}</div>
                                <div class="metric-label">Current Price</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value ${stockData.changeClass}">
                                    ${stockData.changePercent >= 0 ? '+' : ''}${stockData.changePercent.toFixed(2)}%
                                </div>
                                <div class="metric-label">Change %</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value ${stockData.changeClass}">
                                    ${stockData.change >= 0 ? '+' : ''}${formatPrice(Math.abs(stockData.change), currency)}
                                </div>
                                <div class="metric-label">Change Amount</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${formatPrice(stockData.high, currency)}</div>
                                <div class="metric-label">Day High</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${formatPrice(stockData.low, currency)}</div>
                                <div class="metric-label">Day Low</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${formatPrice(stockData.open, currency)}</div>
                                <div class="metric-label">Opening Price</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${formatPrice(stockData.previousClose, currency)}</div>
                                <div class="metric-label">Previous Close</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${formatVolume(stockData.volume)}</div>
                                <div class="metric-label">Volume</div>
                            </div>
                            ${stockData.marketCap ? `
                            <div class="metric-card">
                                <div class="metric-value">${formatVolume(stockData.marketCap)}</div>
                                <div class="metric-label">Market Cap</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2>üìà Market Summary</h2>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                            <div>
                                <p><strong>Symbol:</strong> ${symbol}</p>
                                <p><strong>Exchange:</strong> ${getMarketName(symbol)}</p>
                                <p><strong>Current Price:</strong> ${formatPrice(stockData.currentPrice, currency)}</p>
                                <p><strong>Day Range:</strong> ${formatPrice(stockData.low, currency)} - ${formatPrice(stockData.high, currency)}</p>
                            </div>
                            <div>
                                <p><strong>Change:</strong> <span class="${stockData.changeClass}">${formatPrice(stockData.change, currency)} (${stockData.changePercent.toFixed(2)}%)</span></p>
                                <p><strong>Volume:</strong> ${formatVolume(stockData.volume)}</p>
                                <p><strong>Data Source:</strong> ${stockData.source}</p>
                                <p><strong>Last Updated:</strong> ${lastUpdated}</p>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <p style="margin: 0; color: #6c757d; font-size: 0.9em;">
                                <strong>üìß Accessed from Email Report</strong> | 
                                Real-time data fetched dynamically for ${symbol} | 
                                <button onclick="toggleDebug()" style="background: none; border: 1px solid #ccc; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 0.8em;">Show Debug Info</button>
                            </p>
                        </div>
                    </div>
                `;
            } else {
                document.getElementById('stock-content').innerHTML = `
                    <div class="error-banner">
                        <h3>‚ö†Ô∏è Unable to Load Live Data for ${symbol}</h3>
                        <p><strong>Error:</strong> ${stockData.error || 'All data sources are currently unavailable'}</p>
                        <p><strong>This could happen due to:</strong></p>
                        <ul>
                            <li>Network connectivity issues</li>
                            <li>API rate limits reached</li>
                            <li>Invalid or delisted stock symbol</li>
                            <li>Market closed or weekend hours</li>
                        </ul>
                        <button onclick="refreshData()" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px;">
                            üîÑ Try Again
                        </button>
                    </div>
                `;
            }
        }

        function toggleDebug() {
            debugMode = !debugMode;
            const debugDiv = document.getElementById('debug-info');
            debugDiv.style.display = debugDiv.style.display === 'none' ? 'block' : 'none';
        }

        async function refreshData() {
            if (!currentSymbol) currentSymbol = getStockSymbol();
            
            debugLog(`Refreshing data for ${currentSymbol}...`);
            
            document.getElementById('stock-content').innerHTML = `
                <div class="section loading">
                    <div class="spinner"></div>
                    <h3>üîÑ Refreshing Live Data...</h3>
                    <p>Fetching latest market data for ${currentSymbol}...</p>
                </div>
            `;
            
            const stockData = await fetchStockData(currentSymbol);
            displayStock(stockData);
        }

        async function init() {
            const symbol = getStockSymbol();
            currentSymbol = symbol;
            
            debugLog(`Initializing dynamic stock dashboard for ${symbol}`);
            debugLog(`Market: ${getMarketName(symbol)}`);
            debugLog(`Currency: ${getCurrencySymbol(symbol)}`);
            
            // Update page immediately with symbol info
            document.getElementById('stock-name').textContent = symbol;
            document.getElementById('stock-company').textContent = `Loading ${symbol} from ${getMarketName(symbol)}...`;
            
            const stockData = await fetchStockData(symbol);
            displayStock(stockData);
        }

        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', init);

        // Handle URL changes (back/forward buttons)
        window.addEventListener('popstate', init);
    </script>
</body>
</html>
